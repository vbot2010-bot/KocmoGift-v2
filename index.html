<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Gift Battle Mini App</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- TON Connect UI -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <div class="tabs">
    <button onclick="showTab('home')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
    <button onclick="showTab('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
  </div>

  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <div id="home" class="tab active">
    <h2>üè† –ì–ª–∞–≤–Ω–∞—è</h2>

    <div class="card">
      <p>üí∞ –ë–∞–ª–∞–Ω—Å</p>
      <h1><span id="balance">0</span> TON</h1>
    </div>

    <div class="card">
      <p>üéÅ –ö–µ–π—Å—ã</p>
      <p>–°–∫–æ—Ä–æ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã</p>
    </div>
  </div>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <div id="profile" class="tab">
    <h2>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>

    <img id="avatar" src="" alt="avatar">

    <h3 id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>

    <div class="card">
      <button onclick="connectWallet()">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å TON –∫–æ—à–µ–ª—ë–∫</button>

      <button id="disconnect" onclick="disconnectWallet()" style="display:none">
        ‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫
      </button>

      <p id="wallet">–ö–æ—à–µ–ª—ë–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω</p>
    </div>

    <div class="card">
      <input id="amountInput" type="number" step="0.1" min="0.1" placeholder="–°—É–º–º–∞ (TON)" />
      <button onclick="sendTon()">üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
      <p style="font-size: 12px; opacity: 0.7">
        –ú–∏–Ω–∏–º—É–º 0.1 TON
      </p>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    function showTab(tabId) {
      document.querySelectorAll(".tab").forEach(tab => {
        tab.classList.remove("active");
      });
      document.getElementById(tabId).classList.add("active");
    }
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      // Telegram WebApp
      const tg = window.Telegram.WebApp;
      tg.expand();

      // TonConnect UI
      const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: "https://kocmogift-v22.vercel.app/tonconnect-manifest.json"
      });

      window.tonConnectUI = tonConnectUI;
      window.walletAddress = null;

      tonConnectUI.onStatusChange((wallet) => {
        if (wallet) {
          window.walletAddress = wallet.account.address;

          document.getElementById("wallet").innerText =
            "–ö–æ—à–µ–ª—ë–∫: " +
            window.walletAddress.slice(0, 6) +
            "..." +
            window.walletAddress.slice(-4);

          document.getElementById("disconnect").style.display = "block";
        } else {
          window.walletAddress = null;
          document.getElementById("wallet").innerText = "–ö–æ—à–µ–ª—ë–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω";
          document.getElementById("disconnect").style.display = "none";
        }
      });

      window.connectWallet = function () {
        tonConnectUI.openModal();
      };

      window.disconnectWallet = function () {
        tonConnectUI.disconnect();
      };

      window.sendTon = async function () {
        if (!window.walletAddress) {
          alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª—ë–∫");
          return;
        }

        const amount = parseFloat(document.getElementById("amountInput").value);

        if (!amount || amount < 0.1) {
          alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –º–∏–Ω–∏–º—É–º 0.1 TON");
          return;
        }

        const nanotons = Math.floor(amount * 1_000_000_000);

        const transaction = {
          validUntil: Math.floor(Date.now() / 1000) + 300,
          messages: [
            {
              address: "UQAFXBXzBzau6ZCWzruiVrlTg3HAc8MF6gKIntqTLDifuWOi",
              amount: nanotons.toString()
            }
          ]
        };

        try {
          await tonConnectUI.sendTransaction(transaction);
          alert("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
        } catch (e) {
          alert("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞");
          console.log(e);
        }
      };

    });
  </script>

</body>
</html>
